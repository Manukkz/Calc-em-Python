<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyCalc Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body, .card, .navbar, .offcanvas, .modal-content { transition: background-color 0.3s, color 0.3s; }
        .result-display {
            font-size: 1.8rem; font-weight: bold; color: var(--bs-primary);
            padding: 20px; border-radius: 10px;
            background-color: rgba(var(--bs-primary-rgb), 0.1);
            border: 1px solid rgba(var(--bs-primary-rgb), 0.2);
        }
        .history-item { cursor: pointer; transition: transform 0.2s; }
        .history-item:hover { transform: translateX(5px); }
        [data-bs-theme="dark"] .mjx-chtml { color: #e0e0e0 !important; }
        [data-bs-theme="dark"] .list-group-item-action:hover { background-color: #2b3035; }
        .help-link { text-decoration: none; font-size: 0.9rem; cursor: pointer; }
        .help-link:hover { text-decoration: underline; }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

    <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="fas fa-square-root-variable text-primary"></i> PyCalc Pro</a>
            <button class="btn btn-outline-secondary btn-sm rounded-circle" onclick="toggleTheme()" id="themeBtn"><i class="fas fa-moon"></i></button>
        </div>
    </nav>

    <div class="container flex-grow-1">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                
                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4 text-center">Calculadora Simbólica</h5>
                        
                        <div class="mb-3">
                            <select id="operacao" class="form-select form-select-lg mb-3 text-center" onchange="togglePontoInput()">
                                <option value="derivada">Derivada (d/dx)</option>
                                <option value="integral">Integral (∫)</option>
                                <option value="limite">Limite (lim)</option>
                            </select>
                            
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label mb-0 ms-1 text-muted small">Função f(x)</label>
                                <span class="text-primary help-link" data-bs-toggle="modal" data-bs-target="#helpModal"><i class="fas fa-question-circle"></i> Como digitar?</span>
                            </div>

                            <input type="text" id="funcao" class="form-control form-control-lg text-center" placeholder="Ex: (6*x**3 - 3*x)/(2*x**3)">
                            
                            <div id="ponto-group" class="mt-2 d-none">
                                <input type="text" id="ponto" class="form-control text-center" placeholder="x tende a... (use 'oo' para infinito)">
                            </div>
                        </div>

                        <button onclick="calcular()" class="btn btn-primary w-100 btn-lg rounded-pill shadow-sm">
                            <span id="btn-text">Calcular</span>
                            <span id="loading" class="spinner-border spinner-border-sm ms-2" style="display:none"></span>
                        </button>
                    </div>
                </div>

                <div id="result-area" style="display: none;" class="text-center mb-5">
                    <p class="text-muted small text-uppercase mb-1">Resultado Final</p>
                    <div id="resultado" class="result-display mb-3"></div>
                    
                    <div id="grafico-container" class="mb-3" style="display: none;">
                        <div class="card p-1 d-inline-block bg-white border">
                            <img id="grafico-img" class="img-fluid rounded" alt="Gráfico" style="max-height: 300px;">
                        </div>
                    </div>

                    <button class="btn btn-outline-primary rounded-pill px-4" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSteps">
                        <i class="fas fa-list-ol me-2"></i> Ver Passo a Passo
                    </button>
                </div>

                <div class="card border-0 bg-transparent mb-5">
                    <div class="card-header bg-transparent border-0 d-flex justify-content-between px-0">
                        <span class="fw-bold opacity-75">Histórico</span>
                        <small onclick="limparHistorico()" class="text-danger" style="cursor:pointer">Limpar</small>
                    </div>
                    <ul class="list-group list-group-flush rounded shadow-sm" id="lista-historico"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasSteps">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title"><i class="fas fa-graduation-cap me-2"></i>Passo a Passo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="alert alert-info small mb-3"><i class="fas fa-info-circle me-1"></i> Detalhes do cálculo:</div>
            <div class="accordion accordion-flush" id="accordionSteps"></div>
        </div>
    </div>

    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-keyboard me-2"></i>Guia de Sintaxe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning small">
                        <strong>Importante:</strong> Use parênteses para agrupar divisões!
                    </div>
                    <table class="table table-striped border">
                        <thead><tr><th>Op</th><th>Errado ❌</th><th>Certo ✅</th></tr></thead>
                        <tbody>
                            <tr><td>Multiplicação</td><td>2x</td><td><code>2*x</code></td></tr>
                            <tr><td>Potência</td><td>x^2</td><td><code>x**2</code></td></tr>
                            <tr><td>Divisão</td><td>x+1/x</td><td><code>(x+1)/x</code></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer"><button class="btn btn-primary btn-sm" data-bs-dismiss="modal">Entendi</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Tema
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
        function setTheme(t) {
            document.documentElement.setAttribute('data-bs-theme', t);
            localStorage.setItem('theme', t);
            document.getElementById('themeBtn').innerHTML = t==='dark'?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>';
        }
        function toggleTheme() { setTheme(document.documentElement.getAttribute('data-bs-theme')==='light'?'dark':'light'); }

        // UI
        function togglePontoInput() {
            const op = document.getElementById('operacao').value;
            document.getElementById('ponto-group').classList.toggle('d-none', op !== 'limite');
        }

        // Cálculo
        async function calcular() {
            const func = document.getElementById('funcao');
            const op = document.getElementById('operacao').value;
            const pt = document.getElementById('ponto').value;
            const load = document.getElementById('loading');
            const resArea = document.getElementById('result-area');
            const graphBox = document.getElementById('grafico-container');

            if (!func.value.trim()) { alert("Digite uma função!"); return; }

            load.style.display = 'inline-block';
            document.getElementById('btn-text').textContent = 'Calculando...';
            func.disabled = true;
            resArea.style.display = 'none';
            graphBox.style.display = 'none';

            try {
                // SE FOR RODAR NO RENDER, MUDE A URL ABAIXO PARA SEU LINK DO RENDER
                const response = await fetch('http://127.0.0.1:5000/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ func_str: func.value, operation: op, ponto: pt })
                });
                
                const data = await response.json();

                if (response.ok) {
                    let r = data.result;
                    if (op === 'integral') r += " + C";
                    
                    document.getElementById('resultado').innerHTML = `\\[ ${r} \\]`;
                    
                    if (data.plot) {
                        document.getElementById('grafico-img').src = 'data:image/png;base64,' + data.plot;
                        graphBox.style.display = 'block';
                    }
                    
                    renderPassos(data.steps);
                    addHist(op, func.value, r, pt);
                    resArea.style.display = 'block';
                } else {
                    alert("Erro: " + data.error);
                }
                MathJax.typesetPromise();
            } catch (e) { alert("Erro de conexão."); console.error(e); }
            finally {
                load.style.display = 'none';
                document.getElementById('btn-text').textContent = 'Calcular';
                func.disabled = false;
            }
        }

        function renderPassos(passos) {
            const div = document.getElementById('accordionSteps');
            div.innerHTML = '';
            if(!passos || !passos.length) { div.innerHTML='<p class="text-muted text-center p-3">Sem passos.</p>'; return; }
            
            passos.forEach((p, i) => {
                const id = `step${i}`;
                const show = i===0?'show':'';
                const col = i===0?'':'collapsed';
                div.innerHTML += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${col}" type="button" data-bs-toggle="collapse" data-bs-target="#${id}">Passo ${i+1}</button>
                        </h2>
                        <div id="${id}" class="accordion-collapse collapse ${show}" data-bs-parent="#accordionSteps">
                            <div class="accordion-body">\\[ ${p} \\]</div>
                        </div>
                    </div>`;
            });
        }

        function addHist(op, f, r, p) {
            const ul = document.getElementById('lista-historico');
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action history-item d-flex justify-content-between align-items-center mb-2 rounded border';
            li.innerHTML = `<div><span class="badge bg-secondary me-2">${op}</span><span class="fw-bold font-monospace">\\[${f}\\]</span></div><i class="fas fa-redo-alt text-primary opacity-50"></i>`;
            li.onclick = () => {
                document.getElementById('operacao').value = op;
                document.getElementById('funcao').value = f;
                document.getElementById('ponto').value = p;
                togglePontoInput();
                calcular();
            };
            ul.prepend(li);
            MathJax.typesetPromise([li]);
            if(ul.children.length > 5) ul.removeChild(ul.lastChild);
        }
        function limparHistorico() { document.getElementById('lista-historico').innerHTML = ''; }
    </script>
</body>
</html>